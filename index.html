<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MX Sandbox</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load MathJax for beautiful chemical formulas --><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Custom CSS for the Lab Aesthetic - Beaker styles removed */
        :root {
            --lab-bg: #1f2937; /* Gray-800 equivalent */
        }
        body {
            background-color: var(--lab-bg);
            font-family: 'Inter', sans-serif;
        }
        /* Style for MathJax elements to ensure they are visible on dark background */
        .results-output .mjx-chtml {
            color: #d1d5db !important; /* light gray */
        }
    </style>
</head>
<body class="text-gray-200 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-400">MX Sandbox ðŸ§ª</h1>
            <p class="text-gray-400 mt-2">Design your experiment and observe the simulated results.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Panel 1: Experiment Selection --><div id="selection-panel" class="lg:col-span-1 bg-gray-700 p-6 rounded-xl shadow-2xl h-fit">
                <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-600 pb-2">1. Choose Experiment</h2>
                <div id="experiment-list" class="space-y-3">
                    <!-- Experiment buttons will be dynamically inserted here --></div>
            </div>

            <!-- Panel 2: Controls & Options --><div id="control-panel" class="lg:col-span-1 bg-gray-700 p-6 rounded-xl shadow-2xl h-fit transition-opacity duration-300 opacity-50 pointer-events-none">
                <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-600 pb-2">2. Set Conditions</h2>
                <p id="experiment-desc" class="text-sm text-gray-400 mb-6 italic">Select an experiment to see its description and controls.</p>

                <div id="options-container" class="space-y-6">
                    <!-- Dynamic controls (sliders/selects) will be inserted here --></div>

                <button id="run-button" class="w-full mt-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors duration-200 shadow-md shadow-blue-500/50 pointer-events-none opacity-50" disabled>
                    Run Experiment
                </button>
            </div>

            <!-- Panel 3: Pure Text Observation --><div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-2xl flex flex-col items-center justify-start">
                <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2 w-full text-center">3. Observation</h2>

                <!-- Textual Results - no beaker, just direct output --><div id="results-output" class="w-full p-4 bg-gray-900 rounded-lg shadow-inner border border-gray-700 min-h-[200px] flex flex-col justify-center">
                    <h3 id="result-title" class="text-xl font-bold text-gray-400 text-center">Awaiting Results...</h3>
                    <p id="result-text" class="text-gray-400 mt-4 text-sm italic text-center">
                        Click 'Run Experiment' once you have set the parameters to see the outcome.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CORE EXPERIMENT DATA ---
        const experiments = {
            // EXPERIMENT 1: Malleability Hammer Test (NEW)
            hammerTest: {
                key: 'hammerTest',
                name: "Malleability Hammer Test",
                description: "Simulate hitting a solid element with a hammer. Observe whether the material is <strong>malleable</strong> or has <strong>no change</strong>",
                options: [
                    { id: 'elementSelected', label: 'Element to be Hit', type: 'select', choices: ['Zinc (Zn)', 'Iron (Fe)', 'Aluminum (Al)', 'Copper (Cu)', 'Magnesium (Mg)', 'Nickel (Ni)', 'Iodine (I)'], default: 'Iron (Fe)' },
                ],
                getResult: (opts) => {
                    const element = opts.elementSelected.match(/\((.*?)\)/)[1];
                    let title, text;
                    
                    // Define which elements are malleable (Metals)
                    const malleableMetals = ['Zinc (Zn)', 'Iron (Fe)', 'Aluminum (Al)', 'Copper (Cu)', 'Magnesium (Mg)', 'Nickel (Ni)'];
                    const brittleMetals = ['Iodine (I)']
                    
                    if (malleableMetals.includes(element)) {
                        title = `${element} flattens and bends slightly! `;
                        // Fixed: Replaced ** with <strong> and </strong>
                        text = `The element <strong>${element}</strong> is hit and flattens out. Result: <strong>Malleable</strong>.`;
                    if (brittleMetals.includes(element)) {
                        title = `${element} shatters into small pieces! `;
                        text = `The element <strong>${element}</strong> is hit and shatters into many small pieces. Result: <strong>Brittle</strong>.`;

                    } else {
                        title = `${element} has no change! `;
                        // Fixed: Replaced ** with <strong> and </strong>
                        text = `The element <strong>${element}</strong> is hit and has no difference. Result: <strong>indeterminate</strong>.`;
                    }
                    return { title, text }; // No visual beaker properties returned
                }
            },

            // EXPERIMENT 2: Precipitation Reaction
            precipitation: {
                key: 'precipitation',
                name: "Lead Iodide Precipitation",
                description: "Mix Lead(II) Nitrate ($\text{Pb}(\text{NO}_3)_2$) with Potassium Iodide ($\text{KI}$). Observe the formation of $\text{PbI}_2$.",
                options: [
                    { id: 'concentration', label: 'Reagent Concentration (M)', type: 'slider', min: 0.1, max: 1.0, step: 0.1, default: 0.5, unit: 'M' },
                    { id: 'temperature', label: 'Temperature', type: 'select', choices: ['Room Temp ($\text{25}^\circ\text{C}$)', 'Cold ($\text{5}^\circ\text{C}$)', 'Hot ($\text{80}^\circ\text{C}$)'], default: 'Room Temp ($\text{25}^\circ\text{C}$)' }
                ],
                getResult: (opts) => {
                    const concentration = opts.concentration;
                    const temp = opts.temperature;
                    let title, text; // No colorClass or liquidHeight needed for pure text

                    if (concentration <= 0.3) {
                        title = "Fine Yellow Precipitate";
                        text = `At this low concentration, a fine, pale yellow precipitate of Lead Iodide ($\text{PbI}_2$) is visible, making the solution cloudy.`;
                    } else {
                        title = "Heavy Yellow Precipitate";
                        text = `At high concentration, a heavy, bright yellow solid precipitate ($\text{PbI}_2$) forms immediately.`;
                    }

                    if (temp === 'Hot ($\text{80}^\circ\text{C}$)') {
                        title += " (Heating Effect)";
                        text = `Since the solution is hot, the $\text{PbI}_2$ precipitate has dissolved, leaving a clear solution. It would precipitate out as a beautiful golden solid upon cooling.`;
                    }

                    return { title, text };
                }
            },

            // EXPERIMENT 3: Activity Series
            activitySeries: {
                key: 'activitySeries',
                name: "Activity Series (Single Replacement)",
                description: "Combine a solid metal with an aqueous salt solution. The reaction occurs only if the solid metal is more <strong>active</strong> (reactive) than the metal in the solution, following the single replacement rule.",
                options: [
                    { id: 'solidMetal', label: 'Solid Metal', type: 'select', choices: ['Magnesium (Mg)', 'Zinc (Zn)', 'Copper (Cu)', 'Silver (Ag)'], default: 'Zinc (Zn)' },
                    { id: 'solutionSalt', label: 'Aqueous Salt Solution', type: 'select', choices: ['Copper(II) Sulfate ($\text{CuSO}_4$)', 'Silver Nitrate ($\text{AgNO}_3$)', 'Zinc Chloride ($\text{ZnCl}_2$)', 'Magnesium Nitrate ($\text{Mg}(\text{NO}_3)_2$)'], default: 'Copper(II) Sulfate ($\text{CuSO}_4$)' }
                ],
                getResult: (opts) => {
                    // Extract symbols from parentheses
                    const metal = opts.solidMetal.match(/\((.*?)\)/)[1];
                    // Removing the salt formula part to isolate the metal symbol
                    const solutionSaltMatch = opts.solutionSalt.match(/\((.*?)\)/);
                    let solutionMetal = '';
                    if (solutionSaltMatch && solutionSaltMatch[1]) {
                        // Extracting metal from formula like CuSO4
                        if (opts.solutionSalt.includes('CuSO')) solutionMetal = 'Cu';
                        else if (opts.solutionSalt.includes('AgNO')) solutionMetal = 'Ag';
                        else if (opts.solutionSalt.includes('ZnCl')) solutionMetal = 'Zn';
                        else if (opts.solutionSalt.includes('Mg(NO')) solutionMetal = 'Mg';
                    }
                    
                    // Simplified Activity Series (Mg > Zn > Cu > Ag). Higher index is less reactive.
                    const series = ['Mg', 'Zn', 'Cu', 'Ag'];

                    const metalIndex = series.indexOf(metal);
                    const solutionIndex = series.indexOf(solutionMetal);

                    let title, text; // No colorClass or liquidHeight for pure text

                    if (metalIndex < solutionIndex) {
                        // Reaction occurs: More active metal replaces less active metal ion
                        const reactionEquation = `$$\\text{${metal}} (s) + \\text{${solutionMetal}^{2+}} (aq) \\rightarrow \\text{${solutionMetal}} (s) + \\text{${metal}^{2+}} (aq)$$`;
                        
                        title = "Reaction Occurs!";
                        text = `The solid metal ($\text{${metal}}$) is more reactive than the metal in the solution ($\text{${solutionMetal}}$). The $\text{${solutionMetal}}$ ions are replaced. You would observe the solid $\text{${solutionMetal}}$ depositing and the liquid's color changing due to the formation of $\text{${metal}^{2+}}$ ions. ${reactionEquation}`;
                    } else {
                        title = "No Reaction ($\text{NR}$)";
                        text = `The solid metal ($\text{${metal}}$) is less active than the metal in the solution ($\text{${solutionMetal}}$). No single replacement reaction will occur. The system remains unchanged.`;
                    }
                    return { title, text };
                }
            },
        };

        let currentExperimentKey = null;

        // --- DOM ELEMENTS ---
        const experimentList = document.getElementById('experiment-list');
        const controlPanel = document.getElementById('control-panel');
        const optionsContainer = document.getElementById('options-container');
        const experimentDesc = document.getElementById('experiment-desc');
        const runButton = document.getElementById('run-button');
        // Beaker liquid element is no longer needed
        const resultTitle = document.getElementById('result-title');
        const resultText = document.getElementById('result-text');

        // --- UTILITY FUNCTIONS ---

        /**
         * Renders the initial experiment selection buttons.
         */
        function renderExperimentButtons() {
            experimentList.innerHTML = '';
            Object.values(experiments).forEach(exp => {
                const button = document.createElement('button');
                button.className = 'w-full py-2 px-4 rounded-lg text-left bg-gray-600 hover:bg-blue-600 focus:ring-4 focus:ring-blue-500/50 focus:outline-none transition-colors duration-200 shadow-md';
                button.dataset.key = exp.key;
                button.innerHTML = exp.name;
                button.addEventListener('click', () => selectExperiment(exp.key));
                experimentList.appendChild(button);
            });
        }

        /**
         * Selects an experiment and updates the control panel.
         * @param {string} key
         */
        function selectExperiment(key) {
            currentExperimentKey = key;
            const exp = experiments[key];

            controlPanel.classList.remove('opacity-50', 'pointer-events-none');
            runButton.classList.remove('pointer-events-none', 'opacity-50');
            runButton.disabled = false;
            
            experimentDesc.innerHTML = exp.description;
            MathJax.typesetPromise([experimentDesc]);

            document.querySelectorAll('#experiment-list button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-gray-600', 'hover:bg-blue-600');
                if (btn.dataset.key === key) {
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            });

            renderOptions(exp);
            resetVisuals();
        }

        /**
         * Renders the specific controls for the selected experiment.
         * @param {object} exp - The selected experiment object.
         */
        function renderOptions(exp) {
            optionsContainer.innerHTML = '';
            exp.options.forEach(opt => {
                const container = document.createElement('div');
                container.className = 'bg-gray-600 p-4 rounded-lg shadow-inner';
                
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium text-gray-200 mb-2';
                label.innerHTML = `${opt.label}: <span id="value-${opt.id}" class="font-bold text-blue-300">${opt.default} ${opt.unit || ''}</span>`;
                MathJax.typesetPromise([label]);
                container.appendChild(label);

                if (opt.type === 'slider') {
                    const input = document.createElement('input');
                    input.type = 'range';
                    input.id = opt.id;
                    input.min = opt.min;
                    input.max = opt.max;
                    input.step = opt.step || 1;
                    input.value = opt.default;
                    input.className = 'w-full h-2 bg-gray-500 rounded-lg appearance-none cursor-pointer range-lg transition-colors duration-150 ease-in-out';
                    
                    input.oninput = (e) => {
                        document.getElementById(`value-${opt.id}`).textContent = `${e.target.value} ${opt.unit || ''}`;
                    };

                    container.appendChild(input);

                } else if (opt.type === 'select') {
                    const select = document.createElement('select');
                    select.id = opt.id;
                    select.className = 'w-full p-2 rounded-lg bg-gray-500 border border-gray-400 text-gray-100 focus:ring-blue-500 focus:border-blue-500';
                    
                    opt.choices.forEach(choice => {
                        const option = document.createElement('option');
                        option.value = choice;
                        option.textContent = choice;
                        if (choice === opt.default) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });

                    select.onchange = (e) => {
                        document.getElementById(`value-${opt.id}`).innerHTML = e.target.value;
                        MathJax.typesetPromise([document.getElementById(`value-${opt.id}`)]);
                    };
                    
                    container.appendChild(select);
                }

                optionsContainer.appendChild(container);
            });
        }

        /**
         * Collects the current option values from the controls.
         * @returns {object} An object containing all current option values.
         */
        function getOptionValues() {
            if (!currentExperimentKey) return {};
            const exp = experiments[currentExperimentKey];
            const values = {};
            exp.options.forEach(opt => {
                const element = document.getElementById(opt.id);
                if (element.type === 'range') {
                    values[opt.id] = opt.step && opt.step.toString().includes('.') ? parseFloat(element.value) : parseInt(element.value, 10);
                } else if (element.tagName === 'SELECT') {
                    values[opt.id] = element.value;
                }
            });
            return values;
        }

        /**
         * Executes the selected experiment logic and updates the results panel.
         */
        function runExperiment() {
            if (!currentExperimentKey) return;
            const exp = experiments[currentExperimentKey];
            const options = getOptionValues();
            const result = exp.getResult(options);
            
            // No beaker updates needed.
            
            // Update Text Results
            resultTitle.textContent = result.title;
            resultText.innerHTML = result.text;
            
            // Re-render MathJax in results
            MathJax.typesetPromise([resultText, resultTitle]);
        }
        
        /**
         * Resets the visual display to default.
         */
        function resetVisuals() {
            // No beaker updates needed.
            resultTitle.textContent = 'Awaiting Results...';
            resultText.textContent = 'Click \'Run Experiment\' once you have set the parameters to see the outcome.';
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderExperimentButtons();
            runButton.addEventListener('click', runExperiment);
            
            // Initial MathJax render for buttons/descriptions that contain LaTeX
            MathJax.typesetPromise([experimentList, experimentDesc]);
        });
    </script>
</body>
</html>
